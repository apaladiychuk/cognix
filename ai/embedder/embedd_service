import pulsar
from message_pb2 import DataMessage

# Setup Pulsar client, producer, and consumer without schema
# yeah really don't like that, but it's how to deal with Pulsar
client = pulsar.Client('pulsar://pulsar-cluster:6650')
consumer = client.subscribe('input-topic', subscription_name='my-subscription')
producer = client.create_producer('output-topic')

def process_message(msg):
    data = DataMessage()
    data.ParseFromString(msg.data())
    print(f"Received message: ID={data.id}, Content={data.content}")
    return data

def serve():
    try:
        while True:
            msg = consumer.receive()
            try:
                processed_data = process_message(msg)
                producer.send(processed_data.SerializeToString())
                consumer.acknowledge(msg)
            except Exception as e:
                print("Failed to process message:", e)
                consumer.negative_acknowledge(msg)
    finally:
        client.close()

if __name__ == "__main__":
    serve()
