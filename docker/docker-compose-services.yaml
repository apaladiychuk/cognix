version: '3.5'

services:
  api:
    image: cognix:api
    build:
      context: ../backend
      args:
        service: api
      dockerfile: Dockerfile.dev
    environment:
      PORT: 8080
      STORAGE_PATH: /storage_volume/data
      UI_URL: http://localhost:8080/
    ports:
      - "8080:8080"
    env_file:
      - ../config/cockroach.env
      - ../config/minio.env
      - ../config/.env
    volumes:
      - ../backend:/backend
    networks:
      - dev-network

  orchestrator:
    image: cognix:orchestrator
    build:
      context: ../backend
      args:
        service: orchestrator
      dockerfile: Dockerfile
    env_file:
      - ../config/cockroach.env
      - ../config/nats.env
      - ../config/pulsar.env
      - ../config/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ../backend:/backend
    networks:
      - dev-network

  connector:
    image: cognix:connector
    build:
      context: ../backend
      args:
        service: connector
      dockerfile: Dockerfile.dev
    env_file:
      - ../config/cockroach.env
      - ../config/nats.env
      - ../config/.env
    environment:
      MILVUS_URL: localhost:19530
    volumes:
      - ../backend:/backend
    networks:
      - dev-network

  migration:
    image: cognix:migration
    build: migration
    volumes:
      - ../migration/versions:/versions
    env_file:
      - ../config/cockroach.env
    networks:
      - dev-network



volumes:
  db_volume:
  nats-storage:

networks:
  dev-network:
    driver: bridge
    name: dev-network