services:
  api:
    image: cognix:api
    build:
      context: ./backend
      args:
        service: api
      dockerfile: Dockerfile.dev
    environment:
      PORT: 8080
      STORAGE_PATH: /storage_volume/data
      UI_URL: http://localhost:8080/
    ports:
      - "8080:8080"
    env_file:
      - config/cockroach.env
      - config/minio.env
      - config/.env
    volumes:
      - ./backend:/backend
    networks:
      - dev-network

  orchestrator:
    image: cognix:orchestrator
    build:
      context: ./backend
      args:
        service: orchestrator
      dockerfile: Dockerfile
    env_file:
      - config/cockroach.env
      - config/nats.env
      - config/pulsar.env
      - config/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./backend:/backend
    networks:
      - dev-network

  connector:
    image: cognix:connector
    build:
      context: ./backend
      args:
        service: connector
      dockerfile: Dockerfile.dev
    env_file:
      - config/cockroach.env
      - config/nats.env
      - config/pulsar.env
      - config/.env
    environment:
      MILVUS_URL: localhost:19530
    volumes:
      - ./backend:/backend
    networks:
      - dev-network
  embedding:
    image: cognix:embedding
    build:
      context: ./ai/embedder
      args:
        service: embedding
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    networks:
      - dev-network

  nats:
    image: docker.io/nats:2.9.20
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats-storage:/data
    command:
      - "--name=nats"
      - "--http_port=8222"
      - "--js"
      - "--sd=/data"
    networks:
      - dev-network

  cockroach:
    image: cockroachdb/cockroach:latest-v23.2
    ports:
      - "26257:26257"
      - "28080:8080"
    command: start-single-node --insecure
    volumes:
      - "db_volume:/cockroach/cockroach-data"
    networks:
      - dev-network

  migration:
    image: cognix:migration
    build: migration
    volumes:
      - ./migration/versions:/versions
    env_file:
      - config/cockroach.env
    networks:
      - dev-network

  milvus-admin:
    image: milvusdb/milvus-insight:latest
    environment:
      HOST_URL: http://localhost:8000
      MILVUS_URL: host.docker.internal:19530
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8000:3000"

configs:
  qdrant_config:
    content: |
      log_level: INFO 

volumes:
  db_volume:
  nats-storage:


networks:
  dev-network:
    driver: bridge
    name: dev-network